<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="robots" content="noindex"><meta><title>标签: 端测计算 CoreML - Robin&#039;s Wo</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Robin&#039;s Wo"><meta name="msapplication-TileImage" content="/img/avatar.jpg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Robin&#039;s Wo"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="Robin，80后，主业iOS开发，移动开发者，热爱技术，学习中。很高兴能够在这里与你分享对技术对生活的思考与记录。"><meta property="og:type" content="blog"><meta property="og:title" content="Robin&#039;s Wo"><meta property="og:url" content="https://zycslog.github.io/"><meta property="og:site_name" content="Robin&#039;s Wo"><meta property="og:description" content="Robin，80后，主业iOS开发，移动开发者，热爱技术，学习中。很高兴能够在这里与你分享对技术对生活的思考与记录。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://zycslog.github.io/img/og_image.png"><meta property="article:author" content="Robin"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://zycslog.github.io"},"headline":"Robin's Wo","image":["https://zycslog.github.io/img/og_image.png"],"author":{"@type":"Person","name":"Robin"},"publisher":{"@type":"Organization","name":"Robin's Wo","logo":{"@type":"ImageObject","url":"https://zycslog.github.io/img/avatar.jpg"}},"description":"Robin，80后，主业iOS开发，移动开发者，热爱技术，学习中。很高兴能够在这里与你分享对技术对生活的思考与记录。"}</script><link rel="alternate" href="/atom.xml" title="Robin&#039;s Wo" type="application/atom+xml"><link rel="icon" href="/img/avatar.jpg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }
          Array
              .from(document.querySelectorAll('.tab-content'))
              .forEach($tab => {
                  $tab.classList.add('is-hidden');
              });
          Array
              .from(document.querySelectorAll('.tabs li'))
              .forEach($tab => {
                  $tab.classList.remove('is-active');
              });
          const $activeTab = document.querySelector(location.hash);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
          const $tabMenu = document.querySelector(`a[href="${location.hash}"]`);
          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.1.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/avatar.jpg" alt="Robin&#039;s Wo" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">首页</a><a class="navbar-item" href="/categories/%E6%AF%8F%E6%97%A5%E9%9A%8F%E6%83%B3/">Log</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/about">关于我</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/zycslog"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><div class="card-content"><nav class="breadcrumb" aria-label="breadcrumbs"><ul><li><a href="/tags">标签</a></li><li class="is-active"><a href="#" aria-current="page">端测计算 CoreML</a></li></ul></nav></div></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2022/04/30/2019-09-05-coreml-indepth-look/"><img class="fill" src="/images/coreml-indepth/coreml-og.png" alt="深入了解Core ML 3"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-04-30T06:33:12.089Z" title="4/30/2022, 2:33:12 PM">2022-04-30</time>发表</span><span class="level-item"><time dateTime="2022-04-30T06:33:12.090Z" title="4/30/2022, 2:33:12 PM">2022-04-30</time>更新</span><span class="level-item"> Robin </span><span class="level-item"><a class="link-muted" href="/categories/%E7%AB%AF%E6%B5%8B%E8%AE%A1%E7%AE%97/">端测计算</a></span><span class="level-item">1 小时读完 (大约6934个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/04/30/2019-09-05-coreml-indepth-look/">深入了解Core ML 3</a></h1><div class="content"><hr>
<p>在之前的文章中，介绍过<a target="_blank" rel="noopener" href="https://robinchao.github.io/2017/06/23/ios11-machine-learning.html">iOS 11中的机器学习</a>，简单了解了伴随iOS 11发布的Core ML框架，以及简单的使用方式等，随后，<a target="_blank" rel="noopener" href="https://robinchao.github.io/2017/10/07/coreml-inside.html">Core ML 技术底层探秘</a>也揭开了点Core ML背后的技术和数据结构，对Core ML相对有了一个认识。随着<a target="_blank" rel="noopener" href="https://robinchao.github.io/2018/08/28/coreml-vs-mlkit.html">Core ML vs ML Kit：哪一个移动端机器学习框架更适合你？</a>，简单比较了两者的差异之后，尝试了<a target="_blank" rel="noopener" href="https://robinchao.github.io/2019/01/22/keras-mnist-for-iOS.html">从Keras开始构建iOS平台手写数字实时识别</a>的实现，以及学习了<a target="_blank" rel="noopener" href="https://robinchao.github.io/2018/01/13/turi-create-intro.html">Apple开源机器学习框架 Turi Create 简介与实践</a>，并使用Turi Create进行了人类行为识别任务的尝试，<a target="_blank" rel="noopener" href="https://robinchao.github.io/2018/01/23/turi-create-activity-classifier.html">如何使用Turi Create进行人类行为识别</a>，对Apple的机器学习架构有了基本的认识。经过两次大版本的迭代，目前Core ML 3 也随即推出，对比之前的版本，Core ML 3 可以说已经是一个<strong>完整的端测智能计算架构</strong>，其中也改变了很多实现方式和支持的协议类型等，这里将再次学习，以加深对Core ML的架构认识，并<code>探索其端测智能计算体的使用和可能的业务</code>等。</p>
<hr>
<p>通过<a target="_blank" rel="noopener" href="https://developer.apple.com/videos/frameworks/machine-learning-and-vision">WWDC 2019 Machine Learning and Vision</a>的介绍可以了解到，全新的Core ML 3 为iOS侧的机器学习增加了很多特性，其中称得上杀手锏的是<strong>端测训练</strong>模型的特性，以及支持更多先进的模型结构，由于增加了非常多的新的层类型，是的曾经无法执行的模型结构在端测使用也称为了可能。</p>
<p><img src="/images/coreml-indepth/on-device-training.png"></p>
<p>这次的更新，是2017年Core ML推出以来最大的一次更新。新特性的Core ML配合Apple 的 A12 神经引擎芯片，Apple可谓在端测计算能力上提升了一大步，可想而知，未来苹果会在此方向在此提高和优化，构建完善的CoreML端测计算生态系统。</p>
<p>这篇文章将在<a target="_blank" rel="noopener" href="https://robinchao.github.io/2017/10/07/coreml-inside.html">Core ML 技术底层探秘</a>的基础上，学习<code>mlmodel</code>格式的改变和新增的层类型等，而不会直接涉及<code>CoreML.framework</code>的API（事实上，除了增加了训练模型的API外，其他并没有变化）。</p>
<p>由于Core ML所使用的模型目前都是由其他机器学习框架训练后，进行转换后来使用的，因此如果能够详细的了解Core ML所支持的类型，那么对于设计自己的机器学习模型，并能够顺利投入到Core ML中使用，是有一定的帮助的。</p>
<h2 id="万变不离其宗-—-proto文件"><a href="#万变不离其宗-—-proto文件" class="headerlink" title="万变不离其宗 — proto文件"></a>万变不离其宗 — proto文件</h2><p>如果仅仅是查阅<a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/coreml">CoreML.framework 的 API文档</a>，并不能找到相关的模型格式细节说明等，事实真相是，细节内容并不在API的文档中，而是在<a target="_blank" rel="noopener" href="https://apple.github.io/coremltools/coremlspecification/">Core ML的模型规格文档</a>里。</p>
<p>该规范是由许多包含protobuf消息定义的**.proto**文件组成。Protobuf是Core ML的mlmodel文件使用的序列化格式，该序列化技术是目前较为常用的，TensorFlow和ONNX也同样使用该格式。关于proto文件的具体内容，可以在<a target="_blank" rel="noopener" href="https://apple.github.io/coremltools/coremlspecification/">Core ML的模型规格文档</a>中找到，如果你习惯阅读源码，也可以直接查看<a target="_blank" rel="noopener" href="https://github.com/apple/coremltools/tree/master/mlmodel/format">coremltools repo</a>，其中有目前支持的所有内容。</p>
<p>在所有的proto文件中，主要的格式规格文件是<strong>Model.proto</strong>，该文件中定义了模型的种类，以及输入和输出的类型，另外还定义了已支持模型的不同类型等等。</p>
<p>在该文件中，比较重要的属性还有<code>Model</code>类中的 <strong>specification version</strong>，该属性决定了模型的版本以及哪些函数在mlmodel文件中支持，那个操作系统能够运行模型等。</p>
<p><img src="/images/coreml-indepth/spec-version.png"></p>
<blockquote>
<p>目前官网还没有将<strong>specification version</strong>修改为最新的 <strong>4</strong>，上图是官网文件中的定义，可以预知到正式版推出后，<strong>specification version</strong>将是 <strong>4</strong>。</p>
</blockquote>
<p>Core ML的模型规格版本号为 <strong>4</strong> 的情况下，只能运行在iOS 13 和macOS 10.15（Catalina）或更新的版本上。如果你需要运行在iOS 12或者iOS 11，需要剔除掉最新的特性。</p>
<blockquote>
<p>当使用coremltools进行模型转换的时候，coremltools将选择最低的可能规格版本对模型格式进行兼容。v3版本的模型能够运行在iOS 12上，v2版本的模型能够运行在iOS 11.2上，v1版本能够在iOS 11上运行，当然，如果你的模型使用了任何最新的特性，就只能运行在iOS 13及以后的系统中。</p>
</blockquote>
<h2 id="新的模型类型"><a href="#新的模型类型" class="headerlink" title="新的模型类型"></a>新的模型类型</h2><p>Core ML始终支持以下模型类型（spec v1）：</p>
<ul>
<li><strong>Identity（映射）：</strong> 仅用于测试，将输入数据传递到输出；</li>
<li><strong>GLM（广义线性）：</strong> 支持广义线性回归器和分类器；</li>
<li><strong>SVM（支持向量机）：</strong> 支持支持向量机回归和分类，底层使用的是<a target="_blank" rel="noopener" href="https://www.csie.ntu.edu.tw/~cjlin/libsvm/">libsvm</a>；</li>
<li><strong>Tree ensemble（决策树模型）：</strong> 支持回归和分类；</li>
<li><strong>Neural networks（神经网络）：</strong> 支持回归、分类，以及一般目标的神经网络；</li>
<li><strong>Pipeline models（管道模型）：</strong> 连接多个模型，形成一个机器学习工作流；</li>
<li><strong>Feature engineering（特征工程）：</strong> 这里指的是支持特征工程的数学模型类型，例如<strong>One-Hot编码、缺失值处理、输入矢量化</strong>等，这些主要用于将scikit-learn模型转换为Core ML。该模型将变为一个管道，该管道连续具有多个这些特征工程模型。</li>
</ul>
<p>spec v2 仅仅是一个小小的更新，支持了<strong>16-bit</strong>浮点权重。开启之后，mlmodel文件将减小2倍，但是经过一些使用者反映，此优化并没有提高模型的运行耗时。</p>
<p>在Core ML 2（spec v3）中，增加了如下的模型类型：</p>
<ul>
<li><strong>Bayesian probit regressor（贝叶斯概率回归）：</strong> 一种奇特的逻辑回归版本；</li>
<li><strong>Non-maximum suppression（非极大值抑制）：</strong> 对目标检测任务的后期处理有用，通常位于Pipeline的最后一层；</li>
<li><strong>VisionFeaturePrint（可视化特征描述）：</strong> 用于卷积神经网络，从图像中提取特征，输出规格是2048个元素的向量。也可用于图像的相似性检测等任务；</li>
<li><strong>Create ML Support Models：</strong> 其他来自Create ML工具的模型类型，例如文本分类、词标注等；</li>
<li><strong>Custom models（自定义模型）：</strong> 有时候，你可能有一个CoreML还不支持的模型类型，但是仍然希望将该模型与其他模型放在一起使用。自定义模型的功能允许开发者将模型参数和数据放置在mlmodel文件中，同时将自定义的逻辑放在应用程序中。</li>
</ul>
<p>spec v3 还增加了以减小mlmodel文件大小的<strong>权重量化</strong>功能以及灵活的输入大小，API层面增加了批处理预测，并为顺序数据提供了更好的支持。</p>
<p>在Core ML 3（spec v4）中，增加了如下的模型类型：</p>
<ul>
<li><strong>k-Nearest Neighbors（k-NN，k近邻）：</strong> k-NN分类器；</li>
<li><strong>ItemSimilarityRecommender（基于相似度的推荐器）：</strong> 可以使用该类型构建个性化推荐模型</li>
<li><strong>SoundAnalysisPreprocessing（声音分析预处理）：</strong> 支持Create ML的声音分类模型。输入音频信号样本，并会转换为mel频谱图，可以在Pipeline中用做音频特征模型的输入；</li>
<li><strong>Gazetteer：</strong> 支持Create ML的<code>MLGazetteer</code>模型，使用自然语言处理框架中的<code>NLTagger</code>。一个gazetteer是一个用于单词和短语的花式查找表；</li>
<li><strong>WordEmbedding：</strong> 支持Create ML的新<code>MLWordEmbedding</code>模型，该模型是单词及其嵌入向量的字典。也用于自然语言框架；</li>
<li><strong>Linked models：</strong> 对应用程序包中另一个mlmodel文件（编译版本，mlmodelc）的引用。这使得可以跨多个分类器重用昂贵的特征提取器 - 如果两个不同的管道使用相同的链接模型，则只会加载一次。</li>
</ul>
<p>目前，<code>Model</code>对象的属性中增加了<strong>isUpdatable</strong>属性，当该属性是<code>true</code>时，代表模型可以在端测进行训练，目前仅支持神经网络和k-NN模型。</p>
<p><strong>k-NN模型</strong>是一个相对简单的机器学习模型，非常适合在端测进行训练，常见的方法是使用固定的神经网络，例如VisionFeaturePrint，从输入数据中提取特征，然后使用k-NN对这些特征向量进行分类。这样的模型在训练时很快，因为它只是记住了你输入的样本，并没有做任何实际的学习。</p>
<p><strong>k-NN模型</strong>的一个缺点是，当记忆了非常多的样本时，预测就会变得很慢，但是在Core ML中，使用了一个k-NN的变种**<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/K-d%E6%A0%91">K-D树</a>**。(下图是一个三维k-d树)</p>
<p><img src="/images/coreml-indepth/3dtree.png"></p>
<h2 id="神经网络的更新"><a href="#神经网络的更新" class="headerlink" title="神经网络的更新"></a>神经网络的更新</h2><p>在Core ML 2的版本中，仅支持40中不同的神经网络层类型，Core ML 3中增加了超过100中层类型。但是并不是所有的都是新增，部分是对旧的层类型的改进，以支持或者更加适合处理柔性张量的处理等。</p>
<p>在Core ML 2及之前的版本，流入神经网络的数据总是一个5等级的张量，也就是说每个张量都是由如下5个维度组成的：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(sequence length, batch size, channels, height, width)</span><br></pre></td></tr></table></figure>

<p>当神经网络的输入是图像的话，这个数据结构非常适合，但是对于其他数据结构就不那么适合了。</p>
<p>例如，在处理一维向量的神经网络中，应该使用<code>channels</code>来描述向量的大小，并将其他维度设置为1，在这种情况下，输入的张量形状是<code>(1, batch size, number of elements, 1, 1)</code>。虽然这样的方式也可以解决问题，但是对于开发者来说，无意义的参数设置就是浪费时间，因此在Core ML 3中新增了很多新层来支持任意等级和形状的张量，使Core ML对于处理图像之外的数据也更适合。</p>
<blockquote>
<p>上面部分的描述均来自proto文件中的描述和解释的理解，在其他的文档中并不会去解释和说明这些内容，因此有兴趣的话，可以详细阅读下proto文件的内容，以加深理解。</p>
</blockquote>
<p>在<a target="_blank" rel="noopener" href="https://github.com/apple/coremltools/blob/master/mlmodel/format/NeuralNetwork.proto">NeuralNetwork.proto</a>文件中，接近6000行的内容，对Core ML中神经网络的内容进行了描述和定义。</p>
<p>其中，主对象是<strong>NeuralNetwork</strong>，还有另外两个变种<strong>NeuralNetworkClassifier</strong>和<strong>NeuralNetworkRegressor</strong>，不同的是，普通的神经网络输出的是MultiArray对象或者image，分类器输出的是包含类别和对应预测概率的字典，回归器输出的是一个数值。除了输出和响应的解释不同，但是这三种模型的工作方式是相同的。</p>
<p><strong>NeuralNetwork</strong>对象含有一个层的列表，以及任何图像输入的预处理选项列表。Core ML 3 增加了一些描述的新特性：</p>
<ul>
<li>输入的MultiArray类型是如何转换为张量的。此时，开发者可以选择老的方式，创建一个秩为5的张量，或者使用新的方式。大多数情况下的输入类型都不是图像，因此这里将是常用的方法。</li>
<li>输入的Image类型是如何转换为张量的。更换了老的秩为5的张量，开发者可以使用秩为4的张量，<code>(batch size, channels, height, width)</code>。这里去除了在图像处理中不需要的<code>sequence length</code>维度。</li>
<li>训练模型的超参数。在<strong>NetworkUpdateParameters</strong>中描述。</li>
</ul>
<p>关于<strong>端测训练</strong>的能力，Core ML 3中也相应增加了一些支持的描述，具体如下：</p>
<ul>
<li><strong>isUpdatable</strong>位于<strong>Model</strong>对象中，表示模型是否可以被训练或再训练；</li>
<li>在任何希望进行训练的层中，<strong>isUpdatable</strong>必须设置为<strong>true</strong>。使用该参数，开发者可以控制某些层的训练与否。目前，端测训练仅支持卷积层和全链接层；</li>
<li><strong>WeightParams</strong>是训练时可学习的参数，只有在<strong>isUpdatable</strong>为<strong>true</strong>的时候会起效；</li>
<li>在训练前，需要为模型定义一个训练输入，该输入将用于训练中损失函数的实际标签。</li>
</ul>
<p>另外，在<strong>NetworkUpdateParameters</strong>对象中，定义了模型训练的一些方法和参数等，具体描述如下：</p>
<ul>
<li><strong>lossLayers</strong>：指定使用那种损失函数，目前支持分类交叉熵和MSE（均方误差）。在mlmodel文件中，损失函数是另外的一层，含有两个属性，模型输出层名称和对应目标类别的训练输入名称。对于交叉熵损失函数，输入必须连接softmax输出层；</li>
<li><strong>optimizer</strong>：目前支持SGD（随机梯度下降）和Adam（可替代SGD的一种一阶优化算法）；</li>
<li><strong>epochs</strong>：模型训练的迭代次数。</li>
<li><strong>shuffle</strong>：每次迭代时，数据是否需要随机重新排序；</li>
<li><strong>seed</strong>：随机种子参数。</li>
</ul>
<h2 id="Core-ML-2-中的神经网络层"><a href="#Core-ML-2-中的神经网络层" class="headerlink" title="Core ML 2 中的神经网络层"></a>Core ML 2 中的神经网络层</h2><p> 对于神经网络来说，最有意思的还算各种神经网络层了，在Core ML第一个版本中，支持一下的神经网络层类型：</p>
<ul>
<li><strong>Convolution（卷积层）：</strong>仅支持2维度，但是可以设置内核宽度和高度为1来使用1维。同时支持空洞卷积或扩张卷积、分组卷积和反卷积；</li>
<li><strong>Pooling（池化层）：</strong>支持max、average、L2，以及全局Pooling；</li>
<li><strong>Fully-connected（全链接层）：</strong>也被称为内积层或密集层；</li>
<li><strong>Activation functions（激活函数）：</strong>支持linear、ReLU、leaky ReLU、thresholded ReLU、PReLU、tanh、scaled tanh、sigmoid、hard sigmoid、ELU、softsign、softplus、parametric soft plus；</li>
<li><strong>Batch normalization（批量标准化层）：</strong></li>
<li><strong>Normalization（标准化层）：</strong>mean &amp; variance, L2 norm, and local response normalization (LRN)；</li>
<li><strong>Softmax：</strong>在<strong>NeuralNetworkClassifier</strong>中的最后一层使用；</li>
<li><strong>Padding（填充）：</strong>用于在图像张量的边缘周围添加额外的零填充。卷积和池化层已经可以自己处理填充，但是使用此层可以执行诸如反射或复制填充之类的操作；</li>
<li><strong>Cropping（剪裁）：</strong>用于去除张量边缘周围的像素；</li>
<li><strong>Upsampling（上采样）：</strong>最近邻或双线性上采样整数比例因子；</li>
<li><strong>Unary operations（一元处理）：</strong>sqrt, 1&#x2F;sqrt, 1&#x2F;x, x^power, exp, log, abs, thresholding；</li>
<li><strong>Tensors Element-wise operations（两个及以上张量元素操作）：</strong>add, multiply, average, maximum, minimum；</li>
<li><strong>Tensor Element-wise operations（两单个张量元素操作）：</strong>乘以比例因子，增加偏差；</li>
<li><strong>Reduction operations（降维）：</strong> sum, sum of natural logarithm, sum of squares, average, product, L1 norm, L2 norm, maximum, minimum, argmax；</li>
<li><strong>Dot product（张量点积）：</strong>计算余弦相似度；</li>
<li><strong>Reorganize（张量重组）：</strong> reshape, flatten, permute, space-to-depth, depth-to-space；</li>
<li><strong>Concat, split, and slice（张量联合、分割、切片）：</strong>张量合并或扩张；</li>
<li><strong>Recurrent neural network layers（递归神经网络层）：</strong>basic RNN, uni- and bi-directional LSTM, GRU (unidirectional only)；</li>
<li><strong>Sequence repeat（序列复制）：</strong>多次复制给定的输入序列；</li>
<li><strong>Embeddings</strong></li>
<li><strong>Load constant（负载常数）：</strong>可以用于向一些其他层提供数据，例如对象检测模型中的锚定区。</li>
</ul>
<p>Apple在 Spec v2 中增加了对神经网络中自定义层的支持。这个补充，对更多模型的转换有了很大的帮助。</p>
<p>在mlmodel文件中，自定义图层只是一个占位符，可能具有经过训练的权重和配置参数。在应用程序中，应该提供该层功能的Swift或Objective-C实现，并且可能还有一个Metal版本以及在GPU上运行它。 不幸的是，神经引擎目前不是自定义图层的选项，该功能也仅支持传统机器学习模型。</p>
<p>例如，如果模型需要不在上面列表中的激活函数，则可以将其实现为自定义层。也可以通过巧妙地组合其他一些图层类型来完成此操作。例如，可以通过进行常规ReLU，然后将数据乘以-1，将阈值乘以-6，最后再乘以-1来制作ReLU6。这需要4个不同的层，但理论上，Core ML框架可以在运行时优化它。</p>
<p>在Core ML 2（Spec v3）中，添加了以下图层类型：</p>
<ul>
<li><strong>Resize bilinear：</strong>与上采样层（仅接受整数比例因子）不同，这使您可以将双线性调整为任意图像大小；</li>
<li><strong>Crop-resize：</strong>用于从张量中提取感兴趣的区域。这可以用于实现掩模R-CNN中使用的RoI Align层。</li>
</ul>
<p>在Core ML 3（Spec v4）放宽了对这些现有层类型的要求，除了添加了一大堆新层之外，Core ML 3还使现有的图层类型更加灵活。</p>
<h2 id="新的神经网络层"><a href="#新的神经网络层" class="headerlink" title="新的神经网络层"></a>新的神经网络层</h2><p>上文提到，此次更新，新增了100多个层，下面会一一查看都有哪些层，更加详细的内容可参考<a target="_blank" rel="noopener" href="https://github.com/apple/coremltools/blob/master/mlmodel/format/NeuralNetwork.proto">NeuralNetwork.proto</a>描述文件。</p>
<p>Core ML 3 为元素明确的一元操作添加以下层：</p>
<ul>
<li><strong>ClipLayer</strong>：夹在最大值和最小值；</li>
<li><strong>CeilLayer、FloorLayer</strong>：对张量进行ceil和floor运算；</li>
<li><strong>SignLayer</strong>：告知数字是正数，零数还是负数；</li>
<li><strong>RoundLayer</strong>：将张量的值四舍五入为整数；</li>
<li><strong>Exp2Layer</strong>：对张量元素进行2^x运算；</li>
<li><strong>SinLayer, CosLayer, TanLayer, AsinLayer, AcosLayer, AtanLayer, SinhLayer, CoshLayer, TanhLayer, AsinhLayer, AcoshLayer, AtanhLayer</strong>：（双曲线）三角函数；</li>
<li><strong>ErfLayer</strong>：计算高斯误差函数。</li>
</ul>
<p>这次和运算相关的增加，扩展了Core ML支持的数学原语的数量，与已有的数学函数不同，它们可以处理任何等级的张量。</p>
<p>这里只有一个新的激活函数：</p>
<ul>
<li><strong>GeluLayer</strong>：高斯误差线性单元激活函数，精确的或使用tanh或S形近似。</li>
</ul>
<p>当然，也可以使用任何一元函数作为激活函数，或通过组合不同的数学层来创建一个。</p>
<p>另外还增加了用于比较张量的新的层类型：</p>
<ul>
<li><strong>EqualLayer, NotEqualLayer, LessThanLayer, LessEqualLayer, GreaterThanLayer, GreaterEqualLayer</strong></li>
<li><strong>LogicalOrLayer, LogicalXorLayer, LogicalNotLayer, LogicalAndLayer</strong></li>
</ul>
<p>当条件为真时，这些函数输出一个新的张量，其值为1，反之为0。这些图层类型支持广播，因此您可以比较不同等级的张量。您还可以将张量与（硬编码）标量值进行比较。</p>
<p>这些图层类型有用的一个地方是使用新的控制流操作（见下文），以便您可以根据比较的结果进行分支，或者创建一个循环，该循环一直重复直到某个条件变为false。</p>
<p>以前，在两个或更多张量之间有一些用于元素操作的图层。Core ML 3添加了一些新类型，从名称可以看出这些新增的更加灵活，因为它们完全支持NumPy风格：</p>
<ul>
<li><strong>AddBroadcastableLayer</strong>： 加法</li>
<li><strong>SubtractBroadcastableLayer</strong>：减法</li>
<li><strong>MultiplyBroadcastableLayer</strong>：乘法</li>
<li><strong>DivideBroadcastableLayer</strong>：除法</li>
<li><strong>FloorDivBroadcastableLayer</strong>：除法返回四舍五入的整数结果</li>
<li><strong>ModBroadcastableLayer</strong>：除法余数</li>
<li><strong>PowBroadcastableLayer</strong>：幂运算</li>
<li><strong>MinBroadcastableLayer, MaxBroadcastableLayer</strong>：最大、最小</li>
</ul>
<p>在新的Core ML中，内置了大量的张量操作方法，而且不仅是图像，也可以通过一个或者多个维度的变换来进行张量缩小等。</p>
<ul>
<li><strong>ReduceSumLayer</strong>：计算指定维度的总和</li>
<li><strong>ReduceSumSquareLayer</strong>：计算张量元素的平方和 </li>
<li><strong>ReduceLogSumLayer</strong>：计算元素的自然对数之和</li>
<li><strong>ReduceLogSumExpLayer</strong>：指定元素进行加和，再取自然对数</li>
<li><strong>ReduceMeanLayer</strong>：计算元素的平均值</li>
<li><strong>ReduceProdLayer</strong>：所有元素的乘积</li>
<li><strong>ReduceL1Layer, ReduceL2Layer</strong>： L1、L2标准化</li>
<li><strong>ReduceMaxLayer, ReduceMinLayer</strong>：寻找最大值、最小值</li>
<li><strong>ArgMaxLayer, ArgMinLayer</strong>：最大值、最小值的索引</li>
<li><strong>TopKLayer</strong>：找到k个顶部（或底部）值及其索引。</li>
</ul>
<p>关于数学的计算，Core ML 3还增加了如下的类型：</p>
<ul>
<li><strong>BatchedMatMulLayer</strong>：两个输入张量上的通用矩阵乘法，或单个输入张量和一组固定的权重（加上可选的偏差）。支持广播并可在进行乘法之前转置输入；</li>
<li><strong>LayerNormalizationLayerParams</strong>：一个简单的归一化层，它减去β（例如均值）并除以γ（例如标准偏差），两者都作为固定权重提供。这与现有的MeanVarianceNormalizeLayer不同，后者执行相同的公式但实际上在推理时计算张量的均值和方差。</li>
</ul>
<p>许多其他现有操作已经扩展到使用任意大小的张量，也称为秩-N张量或N维张量。您可以通过名称中的“ND”识别此类图层类型：</p>
<ul>
<li><strong>SoftmaxNDLayer</strong></li>
<li><strong>ConcatNDLayer</strong></li>
<li><strong>SplitNDLayer</strong></li>
<li><strong>TransposeLayerParams</strong></li>
<li><strong>EmbeddingNDLayer</strong></li>
<li><strong>LoadConstantNDLayerParams</strong></li>
</ul>
<p>Core ML 3为我们提供了两个新的切片层，支持在任何轴上切片：</p>
<ul>
<li><strong>SliceStaticLayer</strong></li>
<li><strong>SliceDynamicLayer</strong></li>
</ul>
<p>静态基本上意味着“预先知道此操作的一切”，而动态意味着“此操作的参数可以在运行之间改变”。例如，图层的静态版本可能具有硬编码的outputShape属性，而动态版本每次都可以使用不同的输出形状。</p>
<p>因为Core ML不再局限于基于静态图像的模型，而是现在还包含控制流和其他动态操作的方法，因此它必须能够以各种奇特的方式操纵张量。</p>
<ul>
<li><strong>GetShapeLayer</strong></li>
<li><strong>BroadcastToStaticLayer, BroadcastToLikeLayer，BroadcastToDynamicLayer</strong></li>
<li><strong>RangeStaticLayer, RangeDynamicLayer</strong></li>
<li><strong>FillStaticLayer, FillLikeLayer, FillDynamicLayer</strong></li>
</ul>
<p>其中一些图层类型有三种不同的变体：Like，Static和Dynamic。</p>
<ul>
<li><strong>Static</strong>：该图层的所有属性都在mlmodel文件中进行了硬编码。</li>
<li><strong>Like</strong>：需要一个额外的输入张量并输出一个与输入具有相同形状的新张量。</li>
<li><strong>Dynamic</strong>：它还需要一个额外的输入张量，但这次它不是那个重要的形状，而是它的内容。</li>
</ul>
<p>Core ML 3还允许您通过随机分布采样创建新的张量：</p>
<ul>
<li><strong>RandomNormalStaticLayer, …LikeLayer, …DynamicLayer</strong></li>
<li><strong>RandomUniformStaticLayer, …LikeLayer, …DynamicLayer</strong></li>
<li><strong>RandomBernoulliStaticLayer, …LikeLayer, …DynamicLayer</strong></li>
<li><strong>CategoricalDistributionLayer</strong></li>
</ul>
<p>另外的一些变体层：</p>
<ul>
<li><strong>SqueezeLayer</strong>：删除任何大小为1的维度</li>
<li><strong>ExpandDimsLayer</strong>：和<strong>SqueezeLayer</strong>相反</li>
<li><strong>FlattenTo2DLayer</strong>：将输入张量展平为二维矩阵</li>
<li><strong>ReshapeStaticLayer, ReshapeLikeLayer, ReshapeDynamicLayer</strong></li>
<li><strong>RankPreservingReshapeLayer</strong>：类似NumPy中的<strong>reshape(…, -1)</strong></li>
</ul>
<p>除了任意张量的连续和分割操作外，Core ML 3还增加了以下张量操作操作：</p>
<ul>
<li><strong>TileLayer</strong>：重复张量一定次数</li>
<li><strong>StackLayer</strong>：沿着新轴连接张量</li>
<li><strong>ReverseLayer</strong>：反转输入张量的一个或多个维度</li>
<li><strong>ReverseSeqLayer</strong>：对于存储数据序列的张量，反转序列</li>
<li><strong>SlidingWindowsLayer</strong>：在输入数据上滑动一个窗口，并在每一步返回一个带有窗口内容的新张量</li>
</ul>
<p>同样支持聚集和缩放：</p>
<ul>
<li><strong>GatherLayer, GatherNDLayer, GatherAlongAxisLayer</strong>：给定一组索引，只保留输入张量的那些索引</li>
<li><strong>ScatterLayer, ScatterNDLayer, ScatterAlongAxisLayer</strong>：将一个张量的值复制到另一个张量中，但仅限于给定的索引。除了复制之外，还有其他累积模式：加，减，乘，除，最大和最小。</li>
</ul>
<p>除了能够选择层之外，还可以选择某些指定的层：</p>
<ul>
<li><strong>WhereNonZeroLayer</strong>：创建一个只有非零元素的新张量。您可以将此与张量比较中的掩码张量一起使用，例如LessThanLayer。</li>
<li><strong>WhereBroadcastableLayer</strong>：采用三个输入张量，两个数据张量和一个包含（真）或零（假）的掩码。返回包含第一个数据张量或第二个数据张量元素的新张量，具体取决于掩码中的值是true还是false。</li>
<li><strong>UpperTriangularLayer, LowerTriangularLayer</strong>：将对角线下方或上方的元素归零</li>
<li><strong>MatrixBandPartLayer</strong>：将中心带外的元素归零</li>
</ul>
<p>目前，coremltools 3.0的Beta中还隐藏了一些新的图层类型：</p>
<ul>
<li><strong>ConstantPaddingLayer</strong>：在张量周围添加一定量的填充。与现有的填充图层不同，此图层适用于任何轴，而不仅仅是宽度和高度尺寸。</li>
<li><strong>NonMaximumSuppressionLayer</strong>：已经有一个单独的模型类型用于在边界框上进行NMS，您可以在对象检测检测模型之后将其放入管道中，但现在也可以直接在神经网络内部进行NMS。</li>
</ul>
<p>在Core ML 3中还增加了控制流层，这些层是激动人心的，极大的提高了神经网络的结构适配广度：</p>
<ul>
<li><strong>BranchLayer</strong></li>
<li><strong>LoopLayer</strong></li>
<li><strong>LoopBreakLayer</strong></li>
<li><strong>LoopContinueLayer</strong></li>
<li><strong>CopyLayer</strong></li>
</ul>
<p>这些控制流相关的层，coremltools给出了使用样例，详细使用方式可以参考<a target="_blank" rel="noopener" href="https://github.com/apple/coremltools/blob/master/examples/Neural_network_control_flow_power_iteration.ipynb">Neural_network_control_flow_power_iteration.ipynb</a>。</p>
<p>至此，Core ML 3中的新的内容基本罗列出来了，可以看到，在新的升级更新中，大多数都是针对层张量的创建、整形和操作，还有很多的数学运算能力的提升，但是通过这些操作，开发者已经可以通过定制、组合等来支持新的层类型，然后实现不同的AI任务等。Apple在一步一步地强化着Core ML的体系，以增强端测AI的能力，</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/apple/coremltools">coremltools</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/coreml">Core ML Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://machinethink.net/blog/new-in-coreml3/">An in-depth look at Core ML 3</a></li>
</ul>
</div></article></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1 is-sticky"><!--!--><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="/img/avatar.jpg" alt="Robin&#039;s Wo"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Robin&#039;s Wo</p><p class="is-size-6 is-block">Robin</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>中国·西安</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">58</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">8</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">15</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/zycslog" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/zycslog"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com/zh_robin"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/atom.xml"><i class="fas fa-rss"></i></a></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/Data-Structures-Algorithms-in-Swift/"><span class="level-start"><span class="level-item">Data Structures &amp; Algorithms in Swift</span></span><span class="level-end"><span class="level-item tag">20</span></span></a></li><li><a class="level is-mobile" href="/categories/%E5%BC%80%E5%8F%91%E7%9F%A5%E8%AF%86/"><span class="level-start"><span class="level-item">开发知识</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/categories/%E6%8A%80%E6%9C%AF%E4%BA%BA%E7%94%9F/"><span class="level-start"><span class="level-item">技术人生</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/categories/%E6%95%B0%E6%8D%AE%E7%A7%91%E5%AD%A6/"><span class="level-start"><span class="level-item">数据科学</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/"><span class="level-start"><span class="level-item">机器学习</span></span><span class="level-end"><span class="level-item tag">10</span></span></a></li><li><a class="level is-mobile" href="/categories/%E6%AF%8F%E6%97%A5%E9%9A%8F%E6%83%B3/"><span class="level-start"><span class="level-item">每日随想</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E7%AB%AF%E6%B5%8B%E8%AE%A1%E7%AE%97/"><span class="level-start"><span class="level-item">端测计算</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E8%AF%BB%E4%B9%A6%E5%B0%8F%E8%AE%B0/"><span class="level-start"><span class="level-item">读书小记</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></div></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2022/06/"><span class="level-start"><span class="level-item">六月 2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/05/"><span class="level-start"><span class="level-item">五月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/04/"><span class="level-start"><span class="level-item">四月 2022</span></span><span class="level-end"><span class="level-item tag">49</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/02/"><span class="level-start"><span class="level-item">二月 2021</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li></ul></div></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://www.williamlong.info/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">月光博客</span></span><span class="level-right"><span class="level-item tag">www.williamlong.info</span></span></a></li><li><a class="level is-mobile" href="https://zhangferry.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">zhangferry</span></span><span class="level-right"><span class="level-item tag">zhangferry.com</span></span></a></li><li><a class="level is-mobile" href="https://xcanoe.top/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">轻舟</span></span><span class="level-right"><span class="level-item tag">xcanoe.top</span></span></a></li><li><a class="level is-mobile" href="https://iosdevweekly.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">iOS Dev Weekly</span></span><span class="level-right"><span class="level-item tag">iosdevweekly.com</span></span></a></li></ul></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/avatar.jpg" alt="Robin&#039;s Wo" height="28"></a><p class="is-size-7"><span>&copy; 2022 Robin</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/zycslog"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>